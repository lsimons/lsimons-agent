<!DOCTYPE html>
<html>
<head>
    <title>lsimons-agent</title>
    <style>
        * { box-sizing: border-box; }
        body {
            background: #1a1a1a;
            color: #e0e0e0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; }
        h1 { color: #fff; font-size: 1.5em; margin-bottom: 20px; }
        #messages {
            border: 1px solid #333;
            border-radius: 4px;
            padding: 15px;
            height: 60vh;
            overflow-y: auto;
            margin-bottom: 15px;
            background: #111;
        }
        .message { margin-bottom: 15px; line-height: 1.5; }
        .user { color: #6cf; }
        .agent { color: #9f9; }
        .tool { color: #fc6; font-size: 0.9em; }
        #input-form { display: flex; gap: 10px; }
        #message-input {
            flex: 1;
            background: #222;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            color: #e0e0e0;
            font-family: inherit;
            font-size: 1em;
        }
        #message-input:focus { outline: none; border-color: #6cf; }
        button {
            background: #333;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 10px 20px;
            color: #e0e0e0;
            cursor: pointer;
            font-family: inherit;
        }
        button:hover { background: #444; }
        #send-btn { background: #2a4a6a; }
        #send-btn:hover { background: #3a5a7a; }
    </style>
</head>
<body>
<div class="container">
    <h1>lsimons-agent</h1>
    <div id="messages"></div>
    <form id="input-form" onsubmit="sendMessage(event)">
        <input type="text" id="message-input" placeholder="Type a message..." autofocus>
        <button type="submit" id="send-btn">Send</button>
        <button type="button" onclick="clearChat()">Clear</button>
    </form>
</div>

<script>
const messagesDiv = document.getElementById('messages');
const messageInput = document.getElementById('message-input');
let currentAgentDiv = null;

function addMessage(role, content) {
    const div = document.createElement('div');
    div.className = 'message ' + role;
    div.textContent = (role === 'user' ? 'You: ' : 'Agent: ') + content;
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
    return div;
}

function addTool(name, args) {
    const div = document.createElement('div');
    div.className = 'message tool';
    const argsStr = Object.entries(args)
        .map(([k, v]) => k + '=' + JSON.stringify(v).substring(0, 50))
        .join(', ');
    div.textContent = '[Tool: ' + name + '(' + argsStr + ')]';
    messagesDiv.appendChild(div);
    messagesDiv.scrollTop = messagesDiv.scrollHeight;
}

function sendMessage(event) {
    event.preventDefault();
    const message = messageInput.value.trim();
    if (!message) return;

    addMessage('user', message);
    messageInput.value = '';
    currentAgentDiv = null;

    fetch('/chat', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({message: message})
    }).then(function(response) {
        const reader = response.body.getReader();
        const decoder = new TextDecoder();
        let buffer = '';

        function processChunk() {
            reader.read().then(function(result) {
                if (result.done) return;
                buffer += decoder.decode(result.value);

                const lines = buffer.split('\n');
                buffer = lines.pop();

                let eventType = null;
                for (const line of lines) {
                    if (line.startsWith('event: ')) {
                        eventType = line.substring(7);
                    } else if (line.startsWith('data: ')) {
                        handleEvent(eventType, JSON.parse(line.substring(6)));
                    }
                }
                processChunk();
            });
        }
        processChunk();
    });
}

function handleEvent(eventType, data) {
    if (eventType === 'text') {
        if (currentAgentDiv) {
            currentAgentDiv.textContent += data.content;
        } else {
            currentAgentDiv = addMessage('agent', data.content);
        }
    } else if (eventType === 'tool') {
        addTool(data.name, data.args);
        currentAgentDiv = null;
    } else if (eventType === 'done') {
        currentAgentDiv = null;
    }
}

function clearChat() {
    fetch('/clear', {method: 'POST'}).then(function() {
        messagesDiv.innerHTML = '';
    });
}
</script>
</body>
</html>
